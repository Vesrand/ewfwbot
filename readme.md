# Подготовка
1. Подготовка google сервисов
   1. google cloud
      1. Создать проект на https://console.cloud.google.com/
      2. Подготовить аккаунт для бота, с которого он будет получать доступ к документу. Перейти в https://console.cloud.google.com/apis/credentials и создать сервисный аккаунт (create credentials -> service account), затем в настройках аккаунта перейти в keys -> add key -> JSON -> CREATE, создать новый ключ и после генерации сохранить сгенерированный json файл (сохранить можно только один раз после генерации, затем файл станет недоступен и в случае утери нужно будет сгенерировать снова)
      3. Перейти в https://console.cloud.google.com/apis/library найти там Google Sheets API и Google Drive API и включить их.
   2. Выдать права на гугл таблицу созданному сервис-аккаунту, указав в Share сгенерированную почту.
2. Подготовка обработчика бота/сервера
   1. На сервер, на котором будет запущен обработчик бота, установить node.js (если еще не установлен). На момент разработки использовалась версия 20.11.0 https://nodejs.org/en
   2. Любым удобным способом разместить папку с файлами обработчика бота на сервере. Если установлен гит, можно использовать команду git clone https://github.com/Vesrand/ewfwbot.git перейдя предварительно в нужную папку, а затем получать обновления с помощью команды git pull origin master. Либо просто скачать архив с https://github.com/Vesrand/ewfwbot (зеленая кнопка Code -> Download ZIP)
   3. Созданный в пункте 1.i.b файл с ключом переименовать в service_acc.json и положить в папку с обработчиком бота (в корень, рядом с главным файлом ewfwbot.js)
   4. Открыть файл config.json и в поле googleSheetId между кавычек вставить ID гугл таблицы (можно скопировать из адресной строки после https://docs.google.com/spreadsheets/d/ и до следующего слеша)
   5. Для справки: информация по расположению данных на листах таблиц записана в googlesheets_config.json, в случае каких-то изменений следует отредактировать этот файл. Перед началом работы следует в этом файле поменять параметры sheetId на актуальные (id листа есть в строке браузера в параметре gid) и проверить на актуальность остальные данные. Параметры checkAddrRelative и checkValue служат для самой базовой проверки, что были загружены верные данные (обычно это какие-то заголовки таблиц). (address: [x1,y1,x2,y2], checkAddrRelative: [столбец, строка])
3. Подготовка Discord
   1. Регистрация и настройка бота/приложения в Discord (этот пункт выполнять, если нужно зарегистрировать своего бота в discord, в противном случае выполнить только пункт 3.i.b использовав предоставленный clientId и 3.i.e использовав ссылку из командной строки при запуске обработчика бота)
      1. Создать приложение (New Application) на https://discord.com/developers/applications
      2. На вкладке General Information скопировать Application ID и записать в файл config.json (находится в папке обработчика бота см п.2) в поле clientId
      3. На вкладке Bot:
         1. Задать username - это то имя бота, которое будет отображаться в discord-сервере
         2. Нажать reset token и сохранить сгенерированный токен в файл config.json в поле token
         3. (на данный момент не требуется, можно пропустить) Включить опции Privileged Gateway Intents: Server Members Intent и Message Content Intent
      4. Сгенерировать ссылку-приглашение на сервер. Для этого на вкладке OAuth2 -> URL Generator отметить пункт bot, затем ниже отметить необходимые права (на данный момент это права из группы TEXT PERMISSIONS) и скопировать сгенерированную ссылку
      5. Пригласить бота на свой сервер. Для этого открыть в браузере ссылку-приглашение и выбрать сервер, на который нужно пригласить бота.
   2. Регистрация слеш-команд на сервере
      1. Сохранить ID сервера в config.json в поле guildId. Для этого нажать ПКМ на названии сервера и выбрать Copy Server ID. Если такого пункта нет, то предварительно включить опцию в настройках discord: User Settings -> Advanced -> Developer Mode.
      2. В командной строке находясь в папке с обработчиком бота запустить команду: node deploy-commands.js (для удаления команд бота можно использовать node delete-commands.js, удалить конкретную команду: node delete-commands.js "название команды", при изменениях в составе команд рекомендуется удалять и заново добавлять все команды)
4. Использование бота
   1. Запустить обработчик бота на сервере. В командной строке находясь в папке с обработчиком бота запустить команду: node ewfwbot.js (Примечание для разработчиков: файл config.json изначально пустой и коммитится на гитхаб, поэтому для разработки можно запускать эту команду с параметром dev: node ewfwbot.js dev, тогда будет использован файл dev_config.json, который добавлен в gitignore. Его только нужно сначала вручную создать)
   2. Бот должен после запуска обработчика выйти онлайн на discord-сервере. Описание команд см ниже
   3. Полномочия. Все команды доступны администратору сервера. Остальные права по-умолчанию установлены в соответствии с описанием команд (ниже), но их можно изменить в файле permissions.json

# Описание команд
## Основные
### undo
Отменяет изменения, внесенные последней командой. История изменений не сохраняется между перезапусками обработчика бота. Не все команды имеют режим отката изменений. Если введена команда, не имеющая режима undo, то во избежание нежелательных непредсказуемых отмен последующий вызов undo не возымеет никакого эффекта. Команда undo работает только на 1 последнюю команду, т.е. предпоследнюю команду, как и все предыдущие отменить нельзя. Исключение: команда getroles (чтобы можно было посмотреть на произведенные изменения, а затем их отменить). Возможно в будущем реализую хранение очереди вызовов<br>
*Доступна:* права наследуются от самой отменяемой команды<br>
<br>

### setdrakerate
Установить новый курс дрейка.<br>
*Доступна:* РП-мастер, Арбитр<br>
*Режим undo:* есть <br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|new_rate|число|Новое значение курса дрейка|Да|Нет|

*Пример:* /setdrakerate 1000<br>

## Роли
### getroles
Получить полный список назначенных ролей.<br>
*Доступна:* РП-мастер, Арбитр<br>
*Режим undo:* нет <br>
<br>

### setroleforuser
Привязать дискорд-пользователя к роли для бота.<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|user|пользователь|Пользователь|Да|Нет|
|role|список|Роль для бота|Да|<ul><li>РП-мастер</li><li>Арбитр</li><li>Глава Фракции</li></ul>|
|fraction|список|Фракция (для роли главы фракции)|Нет|<ul><li>Телванни</li><li>Редоран</li><li>Хлаалу</li><li>Храм</li><li>Шестой Дом</li><li>Империя</li><li>Культ Червя</li><li>Гильдия Магов</li><li>Гильдия Бойцов</li><li>Гильдия Воров</li><li>Мораг Тонг</li><li>Двор Родерики</li></ul>|

*Пример:* /setroleforuser @Vesrand Глава Фракции Телванни<br>
<br>

### removerolefromuser
Отвязать дискорд-пользователя от роли для бота. Параметры аналогичны setroleforuser<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
<br>

### setroleforrole
Привязать дискорд-роль к роли для бота.<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|discordrole|Роль|Дискорд-роль|Да|Нет|
|botrole|список|Роль для бота|Да|<ul><li>РП-мастер</li><li>Арбитр</li><li>Глава Фракции</li></ul>|
|fraction|список|Фракция (для роли главы фракции)|Нет|аналогично setroleforuser|
<br>

### removerolefromrole
Отвязать дискорд-роль от роли для бота. Параметры аналогичны setroleforrole<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
<br>

### clearrole
Очистить все значения для роли.<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|role|список|Роль для бота|Да|<ul><li>РП-мастер</li><li>Арбитр</li><li>Глава Фракции</li></ul>|
|fraction|список|Фракция (для роли главы фракции)|Нет|аналогично setroleforuser|
<br>

### setchat
Привязать текущий чат (т.е. тот, из которого запущена команда) как летопись или как чат какой-либо из фракций. Примечание: только один чат может быть установлен как чат фракции, и для каждого чата может быть задана только одна фракция. Старые значения будут перезаписаны.<br>
*Доступна:* РП-мастер<br>
*Режим undo:* есть <br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|chattype|список|Тип чата|Да|<ul><li>Летопись</li><li>Чат Фракции</li></ul>|
|fraction|список|Фракция (для чата фракции)|Нет|аналогично setroleforuser|
<br>

## Боевые

### currentbattles
Получить список текущих сражений.<br>
*Доступна:* РП-мастер, Арбитр<br>
*Режим undo:* нет <br>
<br>

### attack
Атака на указанный объект указанными отрядами. Фракция атакующего автоматически определяется по чату, в котором была введена команда. Результат будет отправлен в чат летописи, а также в чат атакуемой фракции<br>
*Доступна:* Глава Фракции того чата, в который была отправлена команда<br>
*Режим undo:* нет, но есть дополнительное подтверждение действия<br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|target|строка|Объект атаки|Да|Нет|
|squad|строка|Отряды и их количество (через запятую без лишних пробелов, перед количеством знак равенства)|Да|Нет|

*Пример:* /attack Абебаал Стража Дома=1,Боевые торговцы=2,Новобранцы=1<br>
<br>

### defend
Аналогично attack. Используется для защиты своей территории в случае нападения.<br>
<br>

### join
Аналогично attack, но с дополнительным параметром - фракция, на чьей стороне присоединиться к конфликту. Используется для присоединению к одной из сторон конфликта в уже идущей битве.<br>
|Параметр|Тип|Описание|Обязательный|Опции|
|:------:|:-:|:------:|:----------:|:---:|
|target|строка|Объект атаки|Да|Нет|
|fraction|список|Фракция участник конфликта|Да|аналогично setroleforuser|
|squad|строка|Отряды и их количество (через запятую без лишних пробелов, перед количеством знак равенства)|Да|Нет|

*Пример:* /join Абебаал Империя Стража Дома=1,Боевые торговцы=2,Призванные даэдра Телванни=1<br>
<br>
